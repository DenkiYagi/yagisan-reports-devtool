// Generated by Haxe 4.3.7
(function ($hx_exports, $global) { "use strict";
$hx_exports["yagisan"] = $hx_exports["yagisan"] || {};
$hx_exports["yagisan"]["reports"] = $hx_exports["yagisan"]["reports"] || {};
$hx_exports["yagisan"]["reports"]["devtool"] = $hx_exports["yagisan"]["reports"]["devtool"] || {};
$hx_exports["yagisan"]["reports"]["devtool"]["command"] = $hx_exports["yagisan"]["reports"]["devtool"]["command"] || {};
$hx_exports["yagisan"]["reports"]["devtool"]["command"]["YrtPackCommand"] = $hx_exports["yagisan"]["reports"]["devtool"]["command"]["YrtPackCommand"] || {};
function $extend(from, fields) {
	var proto = Object.create(from);
	for (var name in fields) proto[name] = fields[name];
	if( fields.toString !== Object.prototype.toString ) proto.toString = fields.toString;
	return proto;
}
var HxOverrides = function() { };
HxOverrides.cca = function(s,index) {
	var x = s.charCodeAt(index);
	if(x != x) {
		return undefined;
	}
	return x;
};
HxOverrides.substr = function(s,pos,len) {
	if(len == null) {
		len = s.length;
	} else if(len < 0) {
		if(pos == 0) {
			len = s.length + len;
		} else {
			return "";
		}
	}
	return s.substr(pos,len);
};
HxOverrides.now = function() {
	return Date.now();
};
var Reflect = function() { };
Reflect.field = function(o,field) {
	try {
		return o[field];
	} catch( _g ) {
		return null;
	}
};
Reflect.deleteField = function(o,field) {
	if(!Object.prototype.hasOwnProperty.call(o,field)) {
		return false;
	}
	delete(o[field]);
	return true;
};
var StringTools = function() { };
StringTools.isSpace = function(s,pos) {
	var c = HxOverrides.cca(s,pos);
	if(!(c > 8 && c < 14)) {
		return c == 32;
	} else {
		return true;
	}
};
StringTools.ltrim = function(s) {
	var l = s.length;
	var r = 0;
	while(r < l && StringTools.isSpace(s,r)) ++r;
	if(r > 0) {
		return HxOverrides.substr(s,r,l - r);
	} else {
		return s;
	}
};
StringTools.rtrim = function(s) {
	var l = s.length;
	var r = 0;
	while(r < l && StringTools.isSpace(s,l - r - 1)) ++r;
	if(r > 0) {
		return HxOverrides.substr(s,0,l - r);
	} else {
		return s;
	}
};
StringTools.trim = function(s) {
	return StringTools.ltrim(StringTools.rtrim(s));
};
var haxe_Exception = function(message,previous,native) {
	Error.call(this,message);
	this.message = message;
	this.__previousException = previous;
	this.__nativeException = native != null ? native : this;
};
haxe_Exception.thrown = function(value) {
	if(((value) instanceof haxe_Exception)) {
		return value.get_native();
	} else if(((value) instanceof Error)) {
		return value;
	} else {
		var e = new haxe_ValueException(value);
		return e;
	}
};
haxe_Exception.__super__ = Error;
haxe_Exception.prototype = $extend(Error.prototype,{
	get_native: function() {
		return this.__nativeException;
	}
});
var extype_Tuple2 = function(v1,v2) {
	this.value1 = v1;
	this.value2 = v2;
};
var haxe_ValueException = function(value,previous,native) {
	haxe_Exception.call(this,String(value),previous,native);
	this.value = value;
};
haxe_ValueException.__super__ = haxe_Exception;
haxe_ValueException.prototype = $extend(haxe_Exception.prototype,{
});
var haxe_iterators_ArrayIterator = function(array) {
	this.current = 0;
	this.array = array;
};
haxe_iterators_ArrayIterator.prototype = {
	hasNext: function() {
		return this.current < this.array.length;
	}
	,next: function() {
		return this.array[this.current++];
	}
};
var js_node_Fs = require("fs");
var js_node_Path = require("path");
var js_node_buffer_Buffer = require("buffer").Buffer;
var js_npm_MsgPack = require("@msgpack/msgpack");
var js_npm_yargs_YArgs = require("yargs");
var js_npm_yargs_YArgsHelpers = require("yargs/helpers");
var js_npm_yargs_YArgs_$Extern0 = {};
js_npm_yargs_YArgs_$Extern0._new = function(x) {
	if(x != null) {
		x["boolean-negation"] = Reflect.field(x,"booleanNegation");
		Reflect.deleteField(x,"booleanNegation");
	}
	if(x != null) {
		x["camel-case-expansion"] = Reflect.field(x,"camelCaseExpansion");
		Reflect.deleteField(x,"camelCaseExpansion");
	}
	if(x != null) {
		x["combine-arrays"] = Reflect.field(x,"combineArrays");
		Reflect.deleteField(x,"combineArrays");
	}
	if(x != null) {
		x["dot-notation"] = Reflect.field(x,"dotNotation");
		Reflect.deleteField(x,"dotNotation");
	}
	if(x != null) {
		x["duplicate-arguments-array"] = Reflect.field(x,"duplicateArgumentsArray");
		Reflect.deleteField(x,"duplicateArgumentsArray");
	}
	if(x != null) {
		x["flatten-duplicate-arrays"] = Reflect.field(x,"flattenDuplicateArrays");
		Reflect.deleteField(x,"flattenDuplicateArrays");
	}
	if(x != null) {
		x["greedy-arrays"] = Reflect.field(x,"greedyArrays");
		Reflect.deleteField(x,"greedyArrays");
	}
	if(x != null) {
		x["halt-at-non-option"] = Reflect.field(x,"haltAtNonOption");
		Reflect.deleteField(x,"haltAtNonOption");
	}
	if(x != null) {
		x["nargs-eats-options"] = Reflect.field(x,"nargsEatsOptions");
		Reflect.deleteField(x,"nargsEatsOptions");
	}
	if(x != null) {
		x["negation-prefix"] = Reflect.field(x,"negationPrefix");
		Reflect.deleteField(x,"negationPrefix");
	}
	if(x != null) {
		x["parse-numbers"] = Reflect.field(x,"parseNumbers");
		Reflect.deleteField(x,"parseNumbers");
	}
	if(x != null) {
		x["parse-positional-numbers"] = Reflect.field(x,"parsePositionalNumbers");
		Reflect.deleteField(x,"parsePositionalNumbers");
	}
	if(x != null) {
		x["populate--"] = Reflect.field(x,"populateMinusMinus");
		Reflect.deleteField(x,"populateMinusMinus");
	}
	if(x != null) {
		x["set-placeholder-key"] = Reflect.field(x,"setPlaceholderKey");
		Reflect.deleteField(x,"setPlaceholderKey");
	}
	if(x != null) {
		x["short-option-groups"] = Reflect.field(x,"shortOptionGroups");
		Reflect.deleteField(x,"shortOptionGroups");
	}
	if(x != null) {
		x["sort-commands"] = Reflect.field(x,"sortCommands");
		Reflect.deleteField(x,"sortCommands");
	}
	if(x != null) {
		x["strip-aliased"] = Reflect.field(x,"stripAliased");
		Reflect.deleteField(x,"stripAliased");
	}
	if(x != null) {
		x["strip-dashed"] = Reflect.field(x,"stripDashed");
		Reflect.deleteField(x,"stripDashed");
	}
	if(x != null) {
		x["unknown-options-as-args"] = Reflect.field(x,"unknownOptionsAsArgs");
		Reflect.deleteField(x,"unknownOptionsAsArgs");
	}
	return x;
};
js_npm_yargs_YArgs_$Extern0.from = function(x) {
	return js_npm_yargs_YArgs_$Extern0._new(x);
};
function yagisan_reports_devtool_Main_main() {
	var root = js_npm_yargs_YArgs(js_npm_yargs_YArgsHelpers.hideBin(process.argv)).scriptName("yagisan").strict(true).parserConfiguration(js_npm_yargs_YArgs_$Extern0.from({ greedyArrays : false}));
	root.command("yrt","YRT Manipulation",function(cmd) {
		cmd.command("pack <xml...>","Create a YRT file from an XML file and any assets",function(subcmd) {
			subcmd.positional("xml",{ describe : "XML file (usage: `/path/to/xml` or `/path/to/xml@name`)", type : "string", array : true});
			subcmd.option("asset",{ describe : "Append asset file (usage: `--asset /path/to/aseet@name`)", type : "string", array : true, alias : ["A"]});
			subcmd.option("style",{ describe : "Append style xml file (usage: `--style /path/to/style`)", type : "string", alias : ["S"]});
			subcmd.option("out",{ describe : "Set output file path", type : "string", alias : ["O"], demandOption : true});
			return subcmd.check(function(argv,options) {
				var tmp = argv.asset;
				return yagisan_reports_devtool_command_YrtPackCommand_yrtPackCheck({ xmlPaths : argv.xml, assets : tmp != null ? tmp : [], style : argv.style, outputPath : argv.out});
			});
		},function(argv) {
			var tmp = argv.asset;
			return yagisan_reports_devtool_command_YrtPackCommand_yrtPack({ xmlPaths : argv.xml, assets : tmp != null ? tmp : [], style : argv.style, outputPath : argv.out});
		});
		return cmd.command("pack-alpha <xml>","Create a YRT file from an XML file and any assets (legacy format for <= v1.0.0-alpha.13)",function(subcmd) {
			subcmd.positional("xml",{ describe : "XML file path", type : "string"});
			subcmd.option("asset",{ describe : "Append asset (usage: `--asset /path/to/aseet@id`)", type : "string", array : true, alias : ["A"]});
			subcmd.option("out",{ describe : "Set output file path", type : "string", alias : ["O"]});
			return subcmd.check(function(argv,options) {
				var tmp = argv.asset;
				return yagisan_reports_devtool_command_YrtPackCommand_yrtAlphaPackCheck({ xmlPath : argv.xml, assets : tmp != null ? tmp : [], outputPath : argv.out});
			});
		},function(argv) {
			var tmp = argv.asset;
			return yagisan_reports_devtool_command_YrtPackCommand_yrtAlphaPack({ xmlPath : argv.xml, assets : tmp != null ? tmp : [], outputPath : argv.out});
		});
	},function(_) {
		root.showHelp();
	});
	var $arguments = root.parse();
	var tmp = $arguments != null ? $arguments._ : null;
	var tmp1 = tmp != null ? tmp.length : null;
	if((tmp1 != null ? tmp1 : Infinity) <= 0) {
		root.showHelp();
	}
}
var yagisan_reports_devtool_command_FsPromises = require("node:fs/promises");
var yagisan_reports_shared_LegacyYrtFormat = function() { };
yagisan_reports_shared_LegacyYrtFormat.packYrt = function(layoutXml,assets) {
	var assetObject = { };
	var hasAsset = false;
	if(assets != null && assets.size > 0) {
		var jsIterator = assets.entries();
		var _g_lastStep = jsIterator.next();
		while(!_g_lastStep.done) {
			var v = _g_lastStep.value;
			_g_lastStep = jsIterator.next();
			var v1 = v[1];
			if(v1 != null && ((v1) instanceof Uint8Array)) {
				assetObject[v[0]] = v1;
				hasAsset = true;
			}
		}
	}
	if(hasAsset) {
		return js_npm_MsgPack.encode([layoutXml,assetObject]);
	} else {
		return js_npm_MsgPack.encode([layoutXml]);
	}
};
var yagisan_reports_shared_YrtFormat = function() { };
yagisan_reports_shared_YrtFormat.pack = function(yrt) {
	if(yrt.layouts.length <= 0) {
		throw haxe_Exception.thrown("YRTパッケージはレイアウトXMLを1つ以上含む必要があります。");
	}
	var _this = yrt.layouts;
	var result = new Array(_this.length);
	var _g = 0;
	var _g1 = _this.length;
	while(_g < _g1) {
		var i = _g++;
		var x = _this[i];
		result[i] = [x.name,x.xml];
	}
	var yrt1 = yrt.style;
	var this1 = yrt.assets;
	var tmp;
	if(this1 != null) {
		if(this1.size > 0) {
			var obj = { };
			var jsIterator = this1.entries();
			var _g_lastStep = jsIterator.next();
			while(!_g_lastStep.done) {
				var v = _g_lastStep.value;
				_g_lastStep = jsIterator.next();
				obj[v[0]] = v[1];
			}
			tmp = obj;
		} else {
			tmp = null;
		}
	} else {
		tmp = null;
	}
	return js_npm_MsgPack.encode(["YRT",1,{ l : result, s : yrt1, a : tmp}]);
};
function yagisan_reports_devtool_command_YrtPackCommand_yrtAlphaPackCheck(params) {
	if(!js_node_Fs.existsSync(params.xmlPath)) {
		throw haxe_Exception.thrown("Could not find xml: " + params.xmlPath);
	}
	var idSet = new Set();
	var _g = 0;
	var _g1 = params.assets;
	while(_g < _g1.length) {
		var asset = _g1[_g];
		++_g;
		var def = yagisan_reports_devtool_command_YrtPackCommand_parseAssetString(asset);
		var path = def.path;
		var id = def.id;
		if(path == "" || id == "") {
			throw haxe_Exception.thrown("Invalid argument: asset " + asset);
		}
		if(!js_node_Fs.existsSync(path)) {
			throw haxe_Exception.thrown("Could not find asset: " + path);
		}
		if(idSet.has(id)) {
			throw haxe_Exception.thrown("Same asset id specified: " + id);
		}
		idSet.add(id);
	}
	return true;
}
$hx_exports["yagisan"]["reports"]["devtool"]["command"]["YrtPackCommand"]["yrtAlphaPackCheck"] = yagisan_reports_devtool_command_YrtPackCommand_yrtAlphaPackCheck;
function yagisan_reports_devtool_command_YrtPackCommand_parseAssetString(value) {
	var tokens = value.split("@");
	var tmp = tokens[1];
	var tmp1 = tmp != null ? StringTools.trim(tmp) : null;
	return { path : StringTools.trim(tokens[0]), id : tmp1 != null ? tmp1 : ""};
}
function yagisan_reports_devtool_command_YrtPackCommand_loadXml(xmlPath) {
	return yagisan_reports_devtool_command_FsPromises.readFile(xmlPath,{ encoding : "utf-8"});
}
function yagisan_reports_devtool_command_YrtPackCommand_loadAssets(assets) {
	var _this = assets;
	var result = new Array(_this.length);
	var _g = 0;
	var _g1 = _this.length;
	while(_g < _g1) {
		var i = _g++;
		var def = yagisan_reports_devtool_command_YrtPackCommand_parseAssetString(_this[i]);
		var id = [def.id];
		result[i] = yagisan_reports_devtool_command_FsPromises.readFile(def.path).then((function(id) {
			return function(buff) {
				return new extype_Tuple2(id[0],buff);
			};
		})(id));
	}
	return Promise.all(result).then(function(loadedAssets) {
		var assets = new Map();
		var _g = 0;
		var _g1 = loadedAssets;
		while(_g < _g1.length) {
			var x = _g1[_g];
			++_g;
			assets.set(x.value1,x.value2);
		}
		return assets;
	});
}
function yagisan_reports_devtool_command_YrtPackCommand_yrtPackCheck(params) {
	if(params.xmlPaths.length <= 0) {
		throw haxe_Exception.thrown("At least one XML file must be specified");
	}
	var _g = 0;
	var _g1 = params.xmlPaths;
	while(_g < _g1.length) {
		var xmlPath = StringTools.trim(_g1[_g++].split("@")[0]);
		if(!js_node_Fs.existsSync(xmlPath)) {
			throw haxe_Exception.thrown("Could not find xml: " + xmlPath);
		}
	}
	if(params.style != null && !js_node_Fs.existsSync(params.style)) {
		throw haxe_Exception.thrown("Could not find style xml: " + params.style);
	}
	var idSet = new Set();
	var _g = 0;
	var _g1 = params.assets;
	while(_g < _g1.length) {
		var asset = _g1[_g];
		++_g;
		var def = yagisan_reports_devtool_command_YrtPackCommand_parseAssetString(asset);
		var path = def.path;
		var id = def.id;
		if(path == "" || id == "") {
			throw haxe_Exception.thrown("Invalid argument: asset " + asset);
		}
		if(!js_node_Fs.existsSync(path)) {
			throw haxe_Exception.thrown("Could not find asset: " + path);
		}
		if(idSet.has(id)) {
			throw haxe_Exception.thrown("Same asset id specified: " + id);
		}
		idSet.add(id);
	}
	return true;
}
function yagisan_reports_devtool_command_YrtPackCommand_getOutputPath(params) {
	var path = js_node_Path.parse(StringTools.trim(params.xmlPaths[0].split("@")[0]));
	var this1 = params.outputPath;
	var x = js_node_Path.join(path.dir,"" + path.name + ".yrt");
	if(this1 != null) {
		return this1;
	} else {
		return x;
	}
}
function yagisan_reports_devtool_command_YrtPackCommand_loadXmls(xmlPaths) {
	var _this = xmlPaths;
	var result = new Array(_this.length);
	var _g = 0;
	var _g1 = _this.length;
	while(_g < _g1) {
		var i = _g++;
		var tokens = _this[i].split("@");
		var xmlPath = StringTools.trim(tokens[0]);
		var tmp = tokens[1];
		var customName = tmp != null ? StringTools.trim(tmp) : null;
		var name = customName != null && customName != "" ? customName : undefined;
		result[i] = yagisan_reports_devtool_command_FsPromises.readFile(xmlPath,{ encoding : "utf-8"}).then((function(name) {
			return function(xml) {
				return { name : name[0], xml : xml};
			};
		})([name]));
	}
	return Promise.all(result);
}
if(typeof(performance) != "undefined" ? typeof(performance.now) == "function" : false) {
	HxOverrides.now = performance.now.bind(performance);
}
var yagisan_reports_devtool_command_YrtPackCommand_yrtAlphaPack = $hx_exports["yagisan"]["reports"]["devtool"]["command"]["YrtPackCommand"]["yrtAlphaPack"] = (async function(params) {
	var xml = (await yagisan_reports_devtool_command_YrtPackCommand_loadXml(params.xmlPath));
	var assets = (await yagisan_reports_devtool_command_YrtPackCommand_loadAssets(params.assets));
	var template = yagisan_reports_shared_LegacyYrtFormat.packYrt(xml,assets);
	var path = js_node_Path.parse(params.xmlPath);
	var this1 = params.outputPath;
	var x = js_node_Path.join(path.dir,"" + path.name + ".yrt");
	(await yagisan_reports_devtool_command_FsPromises.writeFile(this1 != null ? this1 : x,js_node_buffer_Buffer.from(template),{ flag : "w"}));
});
var yagisan_reports_devtool_command_YrtPackCommand_yrtPack = (async function(params) {
	var layouts = (await yagisan_reports_devtool_command_YrtPackCommand_loadXmls(params.xmlPaths));
	var assets = params.assets.length > 0 ? (await yagisan_reports_devtool_command_YrtPackCommand_loadAssets(params.assets)) : null;
	var style;
	if(params.style != null) {
		var styleXml = (await yagisan_reports_devtool_command_YrtPackCommand_loadXml(params.style));
		style = styleXml;
	} else {
		style = undefined;
	}
	var packed = yagisan_reports_shared_YrtFormat.pack({ layouts : layouts, style : style, assets : assets});
	(await yagisan_reports_devtool_command_FsPromises.writeFile(yagisan_reports_devtool_command_YrtPackCommand_getOutputPath(params),js_node_buffer_Buffer.from(packed),{ flag : "w"}));
});
yagisan_reports_devtool_Main_main();
})(typeof exports != "undefined" ? exports : typeof window != "undefined" ? window : typeof self != "undefined" ? self : this, {});
