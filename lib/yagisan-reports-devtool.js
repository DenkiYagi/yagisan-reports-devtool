// Generated by Haxe 4.3.4
(function ($global) { "use strict";
function $extend(from, fields) {
	var proto = Object.create(from);
	for (var name in fields) proto[name] = fields[name];
	if( fields.toString !== Object.prototype.toString ) proto.toString = fields.toString;
	return proto;
}
var HxOverrides = function() { };
HxOverrides.cca = function(s,index) {
	var x = s.charCodeAt(index);
	if(x != x) {
		return undefined;
	}
	return x;
};
HxOverrides.substr = function(s,pos,len) {
	if(len == null) {
		len = s.length;
	} else if(len < 0) {
		if(pos == 0) {
			len = s.length + len;
		} else {
			return "";
		}
	}
	return s.substr(pos,len);
};
HxOverrides.now = function() {
	return Date.now();
};
var Lambda = function() { };
Lambda.fold = function(it,f,first) {
	var x = $getIterator(it);
	while(x.hasNext()) first = f(x.next(),first);
	return first;
};
var StringTools = function() { };
StringTools.isSpace = function(s,pos) {
	var c = HxOverrides.cca(s,pos);
	if(!(c > 8 && c < 14)) {
		return c == 32;
	} else {
		return true;
	}
};
StringTools.ltrim = function(s) {
	var l = s.length;
	var r = 0;
	while(r < l && StringTools.isSpace(s,r)) ++r;
	if(r > 0) {
		return HxOverrides.substr(s,r,l - r);
	} else {
		return s;
	}
};
StringTools.rtrim = function(s) {
	var l = s.length;
	var r = 0;
	while(r < l && StringTools.isSpace(s,l - r - 1)) ++r;
	if(r > 0) {
		return HxOverrides.substr(s,0,l - r);
	} else {
		return s;
	}
};
StringTools.trim = function(s) {
	return StringTools.ltrim(StringTools.rtrim(s));
};
var haxe_Exception = function(message,previous,native) {
	Error.call(this,message);
	this.message = message;
	this.__previousException = previous;
	this.__nativeException = native != null ? native : this;
};
haxe_Exception.thrown = function(value) {
	if(((value) instanceof haxe_Exception)) {
		return value.get_native();
	} else if(((value) instanceof Error)) {
		return value;
	} else {
		var e = new haxe_ValueException(value);
		return e;
	}
};
haxe_Exception.__super__ = Error;
haxe_Exception.prototype = $extend(Error.prototype,{
	get_native: function() {
		return this.__nativeException;
	}
});
var extype_Tuple2 = function(v1,v2) {
	this.value1 = v1;
	this.value2 = v2;
};
var haxe_ValueException = function(value,previous,native) {
	haxe_Exception.call(this,String(value),previous,native);
	this.value = value;
};
haxe_ValueException.__super__ = haxe_Exception;
haxe_ValueException.prototype = $extend(haxe_Exception.prototype,{
});
var haxe_iterators_ArrayIterator = function(array) {
	this.current = 0;
	this.array = array;
};
haxe_iterators_ArrayIterator.prototype = {
	hasNext: function() {
		return this.current < this.array.length;
	}
	,next: function() {
		return this.array[this.current++];
	}
};
var js_node_Fs = require("fs");
var js_node_Path = require("path");
var js_node_buffer_Buffer = require("buffer").Buffer;
var js_npm_msgpack_MsgPack = require("@msgpack/msgpack");
var js_npm_yargs_YArgs = require("yargs");
var js_npm_yargs_YArgsHelpers = require("yargs/helpers");
function yagisan_reports_devtool_Helper_isEmpty(x) {
	if(x != null) {
		return x.length <= 0;
	} else {
		return true;
	}
}
function yagisan_reports_devtool_Main_main() {
	module.exports = function() {
		var root = js_npm_yargs_YArgs(js_npm_yargs_YArgsHelpers.hideBin(process.argv)).scriptName("yagisan").strict(true);
		root.command("yrt","YRT Manipulation",function(cmd) {
			return cmd.command("pack <xml>","Create a YRT file from a XML file and any assets.",function(subcmd) {
				subcmd.positional("xml",{ describe : "XML file path", type : "string"});
				subcmd.option("asset",{ describe : "Append asset (usage: `--asset /path/to/aseet@id`)", type : "string", array : true, alias : ["A"]});
				subcmd.option("out",{ describe : "", type : "string", alias : ["O"]});
				return subcmd.check(function(argv,options) {
					var tmp = argv.asset;
					return yagisan_reports_devtool_command_YrtPackCommand_yrtPackCheck({ xmlPath : argv.xml, assets : tmp != null ? tmp : [], outputPath : argv.out});
				});
			},function(argv) {
				var tmp = argv.asset;
				return yagisan_reports_devtool_command_YrtPackCommand_yrtPack({ xmlPath : argv.xml, assets : tmp != null ? tmp : [], outputPath : argv.out});
			});
		},function(_) {
			return root.showHelp();
		});
		var $arguments = root.parse();
		var tmp = $arguments != null ? $arguments._ : null;
		var tmp1 = tmp != null ? tmp.length : null;
		if((tmp1 != null ? tmp1 : Infinity) <= 0) {
			root.showHelp();
		}
	};
}
var yagisan_reports_devtool_command_FsPromises = require("node:fs/promises");
function yagisan_reports_shared_TemplatePacker_packTemplate(layoutXml,assets) {
	var assetItems = [];
	if(assets != null) {
		var _g = 0;
		var _g1 = Object.keys(assets);
		while(_g < _g1.length) {
			var k = _g1[_g];
			++_g;
			var v = assets[k];
			if(!((v) instanceof Uint8Array)) {
				throw haxe_Exception.thrown("アセットにUint8Array以外の値が設定されています。 id=\"" + k + "\"");
			}
			if(v != null) {
				assetItems.push(new extype_Tuple2(k,v));
			}
		}
	}
	if(assetItems.length > 0) {
		return js_npm_msgpack_MsgPack.encode([layoutXml,Lambda.fold(assetItems,function(x,acc) {
			acc[x.value1] = x.value2;
			return acc;
		},{ })]);
	} else {
		return js_npm_msgpack_MsgPack.encode([layoutXml]);
	}
}
function yagisan_reports_devtool_command_YrtPackCommand_yrtPackCheck(params) {
	if(!js_node_Fs.existsSync(params.xmlPath)) {
		throw haxe_Exception.thrown("Could not find xml: " + params.xmlPath);
	}
	var idSet = new Set();
	var _g = 0;
	var _g1 = params.assets;
	while(_g < _g1.length) {
		var asset = _g1[_g];
		++_g;
		var def = yagisan_reports_devtool_command_YrtPackCommand_parseAssetString(asset);
		var path = def.path;
		var id = def.id;
		if(yagisan_reports_devtool_Helper_isEmpty(path) || yagisan_reports_devtool_Helper_isEmpty(id)) {
			throw haxe_Exception.thrown("Invalid argument: asset " + asset);
		}
		if(!js_node_Fs.existsSync(path)) {
			throw haxe_Exception.thrown("Could not find asset: " + path);
		}
		if(idSet.has(id)) {
			throw haxe_Exception.thrown("Same asset id specified: " + id);
		}
		idSet.add(id);
	}
	return true;
}
function yagisan_reports_devtool_command_YrtPackCommand_parseAssetString(value) {
	var tokens = value.split("@");
	var tmp = tokens[1];
	var tmp1 = tmp != null ? StringTools.trim(tmp) : null;
	return { path : StringTools.trim(tokens[0]), id : tmp1 != null ? tmp1 : ""};
}
function yagisan_reports_devtool_command_YrtPackCommand_loadXml(xmlPath) {
	return yagisan_reports_devtool_command_FsPromises.readFile(xmlPath,{ encoding : "utf-8"});
}
function yagisan_reports_devtool_command_YrtPackCommand_loadAssets(assets) {
	var _this = assets;
	var result = new Array(_this.length);
	var _g = 0;
	var _g1 = _this.length;
	while(_g < _g1) {
		var i = _g++;
		var def = yagisan_reports_devtool_command_YrtPackCommand_parseAssetString(_this[i]);
		var id = [def.id];
		result[i] = yagisan_reports_devtool_command_FsPromises.readFile(def.path).then((function(id) {
			return function(buff) {
				return new extype_Tuple2(id[0],buff);
			};
		})(id));
	}
	return Promise.all(result).then(function(loadedAssets) {
		var assetsObj = { };
		var _g = 0;
		var _g1 = loadedAssets;
		while(_g < _g1.length) {
			var x = _g1[_g];
			++_g;
			assetsObj[x.value1] = x.value2;
		}
		return assetsObj;
	});
}
function yagisan_reports_devtool_command_YrtPackCommand_getOutputPath(params) {
	var path = js_node_Path.parse(params.xmlPath);
	var this1 = params.outputPath;
	var x = js_node_Path.join(path.dir,"" + path.name + ".yrt");
	if(this1 != null) {
		return this1;
	} else {
		return x;
	}
}
function $getIterator(o) { if( o instanceof Array ) return new haxe_iterators_ArrayIterator(o); else return o.iterator(); }
if(typeof(performance) != "undefined" ? typeof(performance.now) == "function" : false) {
	HxOverrides.now = performance.now.bind(performance);
}
var yagisan_reports_devtool_command_YrtPackCommand_yrtPack = (async function(params) {
	var xml = (await yagisan_reports_devtool_command_YrtPackCommand_loadXml(params.xmlPath));
	var assetObj = (await yagisan_reports_devtool_command_YrtPackCommand_loadAssets(params.assets));
	var template = yagisan_reports_shared_TemplatePacker_packTemplate(xml,assetObj);
	(await yagisan_reports_devtool_command_FsPromises.writeFile(yagisan_reports_devtool_command_YrtPackCommand_getOutputPath(params),js_node_buffer_Buffer.from(template),{ flag : "w"}));
});
yagisan_reports_devtool_Main_main();
})({});
